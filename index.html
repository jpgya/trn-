<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>フォートナイトトラッカー</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-purple-700 via-indigo-600 to-pink-500 min-h-screen flex items-center justify-center p-4">

<div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 md:p-8">

  <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">Fortnite Tracker</h1>

  <!-- ログイン / アカウントメニュー -->
  <div class="flex justify-center gap-4 mb-4">
    <button id="loginBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg">Googleでログイン</button>
    <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hidden">ログアウト</button>
  </div>
  <div id="accountMenu" class="mt-4 hidden text-center">
    <p id="userName" class="font-bold mb-2"></p>
    <a id="proAdminLink" href="admin.html" class="hidden text-indigo-600 hover:underline">管理者画面</a>
  </div>

  <!-- EPIC ID 入力 -->
  <form class="flex flex-col gap-4 mt-4">
    <div>
      <label for="id" class="block text-sm font-medium text-gray-700 mb-1">EPIC ID</label>
      <input type="text" id="id" placeholder="EPIC ID を入力"
        class="w-full rounded-lg border border-gray-300 px-4 py-3 text-gray-800 focus:ring-indigo-400 focus:outline-none transition" />
    </div>
    <a id="trackerLink" target="_blank" rel="noopener noreferrer"
       class="hidden mt-2 block text-center bg-indigo-600 text-white font-bold py-3 rounded-lg transition-all duration-200 hover:bg-indigo-500 hover:scale-105">
       トラッカーを確認する
    </a>
  </form>

  <!-- 検索履歴 -->
  <div id="historyContainer" class="mt-6 hidden">
    <h2 class="text-gray-700 font-medium mb-2">あなたの検索履歴</h2>
    <ul id="historyList" class="list-disc list-inside text-gray-600 text-sm"></ul>
  </div>

  <!-- 人気ランキング -->
  <div id="popularContainer" class="mt-6">
    <h2 class="text-gray-700 font-medium mb-2">人気の検索TOP5</h2>
    <ul id="popularList" class="list-decimal list-inside text-gray-600 text-sm"></ul>
  </div>

  <!-- PRO Gamer申請ボタン -->
  <div class="mt-6 text-center">
    <button onclick="openProForm()" class="rounded bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-500">PRO Gamer 申請</button>
  </div>

  <!-- PRO Gamer申請フォーム -->
  <div id="proForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded shadow max-w-md w-full">
      <h2 class="text-lg font-bold mb-4">PRO Gamer申請</h2>
      <input id="proName" placeholder="名前" class="border p-2 w-full mb-2">
      <input id="proEpic" placeholder="Epic ID" class="border p-2 w-full mb-2">
      <input id="proLink" placeholder="Twitter / 実績リンク" class="border p-2 w-full mb-2">
      <button onclick="submitPro()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-500">送信</button>
      <button onclick="closeProForm()" class="ml-2 bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">キャンセル</button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, onSnapshot, query, orderBy, limit, updateDoc, increment, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

// Firebase 初期化
const firebaseConfig = { /* あなたの設定 */ };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// HTML要素
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userName = document.getElementById("userName");
const accountMenu = document.getElementById("accountMenu");
const proAdminLink = document.getElementById("proAdminLink");
const historyList = document.getElementById("historyList");
const historyContainer = document.getElementById("historyContainer");
const popularList = document.getElementById("popularList");
const trackerLink = document.getElementById("trackerLink");
const inputField = document.getElementById("id");
let currentUser = null;

// --- ログイン / ログアウト ---
loginBtn.onclick = async () => {
  try {
    const provider = new GoogleAuthProvider();
    const result = await signInWithPopup(auth, provider);
    console.log("ログイン成功:", result.user.displayName);
  } catch (error) {
    console.error("ログイン失敗:", error);
    alert("ログインできませんでした: " + error.message);
  }
};
logoutBtn.onclick = async () => {
  try {
    await signOut(auth);
    alert("ログアウトしました");
  } catch (error) {
    console.error(error);
    alert("ログアウトに失敗しました");
  }
};

// --- PRO Gamer フォーム ---
function openProForm(){ document.getElementById("proForm").classList.remove("hidden"); }
function closeProForm(){ document.getElementById("proForm").classList.add("hidden"); }
async function submitPro(){
  const name = document.getElementById("proName").value.trim();
  const epic = document.getElementById("proEpic").value.trim();
  const link = document.getElementById("proLink").value.trim();
  if(!name || !epic){ alert("名前とEpic IDは必須です！"); return; }
  try{
    await addDoc(collection(db,"proApplications"), { name, epic, link, status:"pending", createdAt:new Date() });
    alert("申請を送信しました！");
    closeProForm();
  } catch(err){
    console.error(err);
    alert("送信に失敗しました: " + err.message);
  }
}

// --- 認証状態変更 ---
onAuthStateChanged(auth, async (user) => {
  if(user){
    currentUser = user;
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    historyContainer.classList.remove("hidden");

    try {
      const userDoc = await getDoc(doc(db,"users",user.uid));
      const role = userDoc.exists() ? userDoc.data().role : "User";
      userName.textContent = user.displayName;
      accountMenu.classList.remove("hidden");
      proAdminLink.classList.toggle("hidden", role !== "King");
      subscribeToHistory();
    } catch(err){
      console.error(err);
      alert("ユーザ情報取得に失敗しました: " + err.message);
    }
  } else {
    currentUser = null;
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    historyContainer.classList.add("hidden");
    historyList.innerHTML="";
    accountMenu.classList.add("hidden");
  }
});

// --- EPIC ID 入力イベント ---
inputField.addEventListener("input", () => {
  const epicId = inputField.value.trim().replace(/\s/g,"").toUpperCase();
  if(epicId){
    trackerLink.href = "https://fortnitetracker.com/profile/all/"+encodeURIComponent(epicId)+"/events";
    trackerLink.textContent = "トラッカーを確認する";
    trackerLink.classList.remove("hidden");

    if(currentUser) saveSearch(currentUser.uid, epicId);
    else saveLocalHistory(epicId);
  } else trackerLink.classList.add("hidden");
});

// --- Firestore 検索履歴保存 ---
async function saveSearch(userId, epicId){
  try{
    await setDoc(doc(db,"users",userId,"history",epicId), { searchedAt:new Date() });
    const popularDoc = doc(db,"popular",epicId);
    try{ await updateDoc(popularDoc, { count:increment(1) }); }
    catch{ await setDoc(popularDoc, { count:1 }); }
  } catch(err){
    console.error(err);
  }
}

// --- ローカル履歴（未ログイン用） ---
function saveLocalHistory(epicId){
  const history = JSON.parse(localStorage.getItem("localHistory")||"[]");
  if(!history.includes(epicId)){
    history.push(epicId);
    localStorage.setItem("localHistory", JSON.stringify(history));
  }
  renderLocalHistory();
}
function renderLocalHistory(){
  const history = JSON.parse(localStorage.getItem("localHistory")||"[]");
  historyList.innerHTML="";
  history.forEach(id=>{
    const li = document.createElement("li");
    li.textContent = id;
    li.classList.add("cursor-pointer","hover:text-indigo-600");
    li.onclick=()=>{ inputField.value=id; trackerLink.click(); };
    historyList.appendChild(li);
  });
}

// --- Firestore 履歴購読 ---
function subscribeToHistory(){
  if(!currentUser) return;
  const q = query(collection(db,"users",currentUser.uid,"history"), orderBy("searchedAt","desc"));
  onSnapshot(q,(snap)=>{
    historyList.innerHTML="";
    snap.forEach(docSnap=>{
      const li = document.createElement("li");
      li.textContent = docSnap.id;
      li.classList.add("cursor-pointer","hover:text-indigo-600");
      li.onclick=()=>{ inputField.value=docSnap.id; trackerLink.click(); };
      historyList.appendChild(li);
    });
  });
}

// --- 人気TOP5 ---
const popularQ = query(collection(db,"popular"), orderBy("count","desc"), limit(5));
onSnapshot(popularQ,(snap)=>{
  popularList.innerHTML="";
  snap.forEach(docSnap=>{
    const li = document.createElement("li");
    li.textContent = docSnap.id;
    li.classList.add("cursor-pointer","hover:text-indigo-600");
    li.onclick=()=>{ inputField.value=docSnap.id; trackerLink.click(); };
    popularList.appendChild(li);
  });
});
</script>
</body>
</html>
